<html xmlns:th="http://www.thymeleaf.org">

<head th:include="layout :: head(title=~{::title},links=~{})">
<title>View Patient Obstetrics Records</title>
</head>

<body th:include="layout :: body" th:with="content=~{::content}">
	<div th:fragment="content">

		<script th:inline="javascript">
                /* Otherwise Thymeleaf tries to parse Javascript as XML and breaks itself sometimes.  Sigh */
                /*<![CDATA[*/
                var app = angular.module('myApp', []);
                app.controller('viewPatientObstetricsRecords', function ($scope, $http) {
                    $scope.Object = Object; // Allows for use of Object.keys()
                    $scope.priorPregnancies = [];
                    $scope.currentPregnancy = {lastMenstrualPeriod:'', estDueDate:''}; // probably need number of weeks
                    //$scope.lmpInputDate = new Date();
                    
                    
					$scope.record = { lmpdate:''};
                    // Display users' names
                    $scope.displayName = function (p) {
                        return p.firstName + " " + p.lastName + " (" + p.self.username + ")";
                    }

                    // documentation on Angular filters: https://docs.angularjs.org/api/ng/filter/filter
                    $scope.searchFilter = "";
                    $scope.filterPatients = function (patient) {
                    	return ($scope.displayName(patient)).toLowerCase().match($scope.searchFilter.toLowerCase());
                    }
                    
                    //Get info for the patients
                    $http.get("/iTrust2/api/v1/patients/female")
                    	.then(
                        function (response) {
                            $scope.patients = response.data; //all patients
                        },
                        function (rejection) {
                            $scope.patient = null;
                        });
                    
                    //Get data associated with selected patient
                    $scope.selectPatient = function (patient) {
                    	// Get past pregnancy info for patient
                        $http.get("/iTrust2/api/v1/pregnancies/" + $scope.selectedPatient)
                        	.then(
                            function (response) { // on success
                            	console.log("Success priorPregnancies");
                            	$scope.priorPregnancies = response.data || [];
                                $scope.message = "";
                                console.log("priorPregnancies?");
                                console.log(response.data);
                            }, //if it failed
                            function (rejection) {
                            	//console.log("Fail pregnancy");
                            	$scope.priorPregnancies = [];
                                $scope.message = "Could not display prior pregnancies.";
                            });
                        
                        // Get current pregnancy info for patient
                        $http.get("/iTrust2/api/v1/obstetricsrecord/" + $scope.selectedPatient)
                        	.then(
                            function (response) { // on success
                            	//console.log("Success obst records");
                            	$scope.currentPregnancy = response.data || {};
                                $scope.message = "";
                                console.log(response.data);
                            }, //if it failed
                            function (rejection) {
                            	//console.log("Fail obst records");
                            	$scope.currentPregnancy = {};
                                $scope.message = "Could not display current pregnancy.";
                            });
                     };
                
						// Stuff for submitting new record ----------------- - - -- - - - - - - - - - - - - -  -- - 
						$scope.failAddEntry = function() {
			              	$scope.errorMsg += "Could not add Obstestric record."
			 				$scope.message = "";
			      		}
			      		


						//Submit functionality for LMP input
						$scope.submitOb = function() {
							$scope.lmpInputDate = new Date();
	    					// Validate entry date
	                        var checkDate = new Date($scope.lmpInputDate);
							var now = new Date(); // make sure it's not a future date
							if (!(checkDate instanceof Date) || isNaN(checkDate) || now - checkDate < 0) {
	    						$scope.errorMsg += "Please input a valid date.\n";
	    					} else {
	    						var dd = checkDate.getDate();
								var mm = checkDate.getMonth()+1; 
								var yyyy = checkDate.getFullYear();
								if(dd < 10) 
								{
								   dd = '0' + dd;
								} 
								
								if(mm < 10) 
								{
								   mm = '0' + mm;
								} 
	    						now = yyyy + '-' + mm + '-' + dd;
	    						
	    						console.log(now);
	    						$scope.record.lmpdate = now;
	    					}
	    					
	    					//console.log("**Date string");
	    					// The date string needs to be in the form YYYY-MM-DD to be parsed correctly, but it looks like what
	    					// it shows in this toString() function: https://docs.oracle.com/javase/7/docs/api/java/util/Date.html#getMonth()
	    					
	    					// Thanks for the info. This is very helpful!
	    					

	                        // Post the record to the REST API endpoint, and handle success/error
	              			//console.log($scope.record);
	     					$http.post("/iTrust2/api/v1/obstetricsrecord/" + $scope.selectedPatient, $scope.record)
								.then(
									function success(response) {
									if (response.data.patient) { //patient only exists on success
										$scope.message = "Obstetrics record has been added successfully."
									    $scope.record = { lmpdate:''};
										$scope.errorMsg = "";
										document.location.href = '/iTrust2/hcp/viewPatientObstetricsRecords.html';
									} else {
										console.log("You shouldn't have deleted this :)");
									}
								},
								function failure(rejection) {
									$scope.failAddEntry();
								});
							}
                });
                /*]]>*/
            </script>

		<div ng-app="myApp" ng-controller="viewPatientObstetricsRecords" class="row">
			<div class="col-md-3">
				<h2>Patients: hello</h2>
				<!-- info on filtering taken from here: https://www.w3schools.com/angular/angular_filters.asp
                    and https://docs.angularjs.org/api/ng/filter/filter -->
				<h4>
					Search: <input type="text" name="search" ng-model="searchFilter" />
				</h4>
				<!-- Info on scrolling taken from here: https://www.w3schools.com/cssref/pr_pos_overflow.asp -->
				<!-- and here: https://stackoverflow.com/questions/9560330/how-to-hide-a-vertical-scroll-bar-when-not-needed -->
				<div>
					<div class="radio"
						ng-repeat="patient in patients | filter:filterPatients">
						<label> <input type="radio" id="{{patient.self.username}}"
							ng-model="$parent.selectedPatient" name="patient"
							value="{{patient.self.username}}"
							ng-click='$parent.selectPatient(patient)' />
							&nbsp;{{$parent.displayName(patient)}}
						</label>
					</div>
				</div>
			</div>

			<div class="col-md-9">
				<div class="panel panel-primary">
					<div class="panel-heading">
						<h3>Obstetrics Records{{ selectedPatient ? ' for ' + selectedPatient
							: '' }}</h3>
					</div>
					<div class="panel-body">
						<div style="margin-left: 10px;">
							<div ng-if="!selectedPatient">Please select a patient for
								which to view Obstetrics Records.</div>
							<div
								ng-if="selectedPatient && currentPregnancy.length == 0">
								<!-- currentPregnancy = {{currentPregnancy}} -->
								There is no current pregnancy recorded for this patient.<br><br>
							</div>

							<div
								ng-if="selectedPatient && (!priorPregnancies || Object.keys(priorPregnancies).length == 0)">
								<!-- currentPregnancy = {{currentPregnancy}}
								PriorPregnancies = {{priorPregnancies}} -->
								<!--List = {{Object.keys(priorPregnancies)}} -->
								There are no past pregnancies recorded for this patient.<br><br>
							</div>
						</div>

					<div class="col-md-5" ng-if="selectedPatient && currentPregnancy.length == 0">
						<div class="form-group">
							<label for="date">Last Menstrual Period</label>
								<input class="form-control"
								id="date" type="date" ng-model="lmpInputDate"  name="date"
								required="true" />
						</div>
					</div>
						<!-- If the current pregnancy exists, display the information.
						Otherwise, let the user create a new record by entering the LMP. -->
						{{selectedPatient}}
						<div ng-if="selectedPatient && currentPregnancy.length > 0">
								<b>Current Pregnancy Information: </b>
								<br> Last Menstrual Period :{{currentPregnancy.lastMenstrualPeriod}}
								<br> Estimated Due Date    :{{currentPregnancy.estDueDate}}
								<br> Weeks Pregnant        : Some amount of weeks
						</div>

						<div
							ng-if="priorPregnancies && Object.keys(priorPregnancies).length > 0">
							<b>Prior Pregnancies</b>
						</div>

						<table class="table table-bordered"
							ng-repeat="field in priorPregnancies">
							<thead>
								<tr>
									<th>Year of Conception</th>
									<th>Weeks Pregnant</th>
									<th>Hours in Labor</th>
									<th>Delivery Method</th>
									<th>Twins</th>
								</tr>
							</thead>
							<tbody>
								<tr ng-repeat="field track by $index">
									<td id="conceptionYear-{{$index}}">{{field.conceptionYear}}</td>
									<td id="numWeeksPregnant-{{$index}}">{{field.numWeeksPregnant}}</td>
									<td id="numHoursInLabor-{{$index}}">{{field.numHoursInLabor}}</td>
									<td id="deliveryMethod-{{$index}}">{{field.deliveryMethod}}</td>
									<td id="isTwins-{{$index}}">{{field.isTwins}}</td>
								</tr>
							</tbody>
						</table>
						
						<div class="form-group" ng-if="selectedPatient && currentPregnancy.length == 0">
							<button type="submit" class="btn btn-primary" ng-click=submitOb()
								name="submitOb" id="submitOb">Create Record</button>
						</div>
					</div>
				</div>
			</div>
		</div>
</body>

</html>